# AIX 自动化交易系统 (AIX Auto Trading System)

<div align="center">

**高性能多账号自动化交易系统 | 专为 AIX Prediction Market 设计**

[![Python 3.8+](https://img.shields.io/badge/python-3.8+-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

</div>

---

## 📋 目录

- [核心特性](#-核心特性)
- [系统架构](#-系统架构)
- [技术亮点](#-技术亮点)
- [快速开始](#-快速开始)
- [配置指南](#-配置指南)
- [使用说明](#-使用说明)
- [性能优化](#-性能优化)
- [常见问题](#-常见问题)
- [免责声明](#-免责声明)

---

## 🚀 核心特性

### 智能监控与交易
- **⚡ 精准卡点下注**: 基于 Playwright 实时监控网页倒计时，在最后 3 秒（可配置）触发批量下注
- **🎯 双重数据源**: 网页 DOM 读取开盘价 + 浏览器内 API 获取当前价，确保数据准确性
- **🔄 动态替补机制**: 账户完成 100 次后自动替换，保持满额并发，最大化效率

### 多账号管理
- **🤖 无限账号支持**: 通过 `accounts.csv` 导入任意数量账号，全自动并发执行
- **📊 智能分组**: 默认 4 个账号并发，动态替补确保所有账号完成每日 100 次任务
- **💾 会话缓存**: 自动缓存登录会话，减少重复登录，提升响应速度

### 安全与稳定
- **🛡️ CloudFlare 绕过**: 集成 Playwright Stealth 插件，自动通过 CloudFlare 验证
- **🌐 代理支持**: 支持 DataImpulse 动态代理，防止 IP 封禁
- **🔐 本地签名**: 私钥仅用于本地签名，不上传服务器，确保资金安全
- **📅 自动任务**: 自动检测并领取每日签到奖励

---

## 🏗️ 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    AIX 自动化交易系统                          │
└─────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
   ┌────▼────┐         ┌──────▼──────┐      ┌──────▼──────┐
   │ 监控层   │         │  数据层      │      │  执行层      │
   └────┬────┘         └──────┬──────┘      └──────┬──────┘
        │                     │                     │
┌───────▼────────┐   ┌────────▼────────┐   ┌───────▼────────┐
│ Playwright     │   │ Enhanced        │   │ Order          │
│ 浏览器监控      │   │ Browser API     │   │ Manager        │
│ • 倒计时监控    │   │ • current-round │   │ • 批量下单      │
│ • 颜色检测      │   │ • c10-composition│  │ • 会话管理      │
│ • DOM 读取      │   │ • Stealth 模式  │   │ • 动态替补      │
└────────────────┘   └─────────────────┘   └────────────────┘
```

### 核心模块

| 模块 | 文件 | 功能 |
|------|------|------|
| **主监控程序** | `aix_monitor.py` | 浏览器监控、触发逻辑、批量下单协调 |
| **订单管理器** | `order_manager.py` | 账户登录、会话管理、批量下单、动态替补 |
| **API 客户端** | `enhanced_browser_api_client.py` | 浏览器内 API 调用，完全模拟真实浏览器 |
| **代理管理器** | `proxy_manager.py` | DataImpulse 动态代理配置 |
| **启动器** | `launcher.py` | 统一启动菜单 |

---

## 💡 技术亮点

### 1. 增强版浏览器 API 客户端
- **完全模拟真实浏览器**: 精确复制 Chrome 144 的所有请求头
- **自动继承认证状态**: 利用已打开页面的 Cookie 和 Session
- **CloudFlare 友好**: 通过 Stealth 插件 + 真实浏览器环境绕过检测
- **智能重试机制**: 指数退避 + 最多 3 次重试

### 2. 动态替补并发模式
```python
# 传统模式：固定 10 个账号，完成后停止
# 动态替补模式：保持 4 个账号并发，完成后自动替换
┌─────────────────────────────────────────────────┐
│ Round 1: [A1, A2, A3, A4] → 4 个账号并发         │
│ Round 2: [A1, A2, A3, A4] → A1 完成 100 次       │
│ Round 3: [A5, A2, A3, A4] → A1 替换为 A5        │
│ ...                                             │
│ 直到所有账号完成 100 次                           │
└─────────────────────────────────────────────────┘
```

### 3. 双重数据源策略
- **开盘价**: 优先从网页 DOM 读取（`C10_OPEN_SELECTOR`）
- **当前价**: 通过浏览器内 API 获取（`/c10-composition`）
- **容错机制**: DOM 读取失败时自动降级到 API 数据

### 4. 性能优化
- **HTTP 连接池**: 100 总连接数 + 20 每 Host 连接数
- **DNS 缓存**: 5 分钟 TTL，减少 DNS 查询
- **会话预热**: 启动时预热前 N 个账号，减少首次下单延迟
- **并行获取**: 使用 `asyncio.gather` 并行获取多个数据源

---

## 🎯 快速开始

### 1. 环境准备

**系统要求**:
- Python 3.8 或更高版本
- Windows / Linux / macOS
- 至少 2GB 可用内存

**安装依赖**:
```bash
# 克隆项目
git clone <your-repo-url>
cd aixs

# 安装依赖
pip install -r requirements.txt

# 安装 Playwright 浏览器
playwright install chromium
```

### 2. 配置账号

创建 `accounts.csv` 文件：
```csv
label,private_key,enabled
主账号,0x1234567890abcdef...,true
副账号1,0xabcdef1234567890...,true
副账号2,0xfedcba0987654321...,false
```

### 3. 启动程序

```bash
# 方式 1: 使用启动菜单（推荐）
python launcher.py

# 方式 2: 直接运行主程序
python aix_monitor.py
```

---

## ⚙️ 配置指南

### 1. 账号配置 (`accounts.csv`)

| 字段 | 说明 | 示例 |
|------|------|------|
| `label` | 账号别名（日志显示） | `主账号` |
| `private_key` | 钱包私钥（0x 开头） | `0x1234...` |
| `enabled` | 是否启用（true/false） | `true` |

**注意事项**:
- 私钥仅用于本地签名，不会上传服务器
- 建议使用专用账号，不要使用主钱包
- `enabled=false` 的账号会被跳过

### 2. 系统配置 (`config.json`)

```json
{
  "api": {
    "base_url": "https://hub.aixcrypto.ai/api/game",
    "timeout_seconds": 7
  },
  "trigger": {
    "target_seconds": 3.0,
    "visual_offset": 0.0,
    "concurrency": 4,
    "auto_bet": {
      "enabled": true
    },
    "browser_trigger": {
      "countdown_seconds": 3,
      "required_color": "emerald",
      "headless": true
    }
  },
  "proxy": {
    "enabled": false,
    "host": "74.81.81.81",
    "start_port": 10000,
    "username": "your_username",
    "password": "your_password",
    "countries": "sg,gb,hk,jp"
  }
}
```

**配置项说明**:

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `trigger.countdown_seconds` | 触发下注的倒计时秒数 | `3` |
| `trigger.concurrency` | 并发账号数量 | `4` |
| `trigger.auto_bet.enabled` | 是否开启自动下注 | `true` |
| `browser_trigger.headless` | 无头模式（服务器推荐） | `true` |
| `proxy.enabled` | 是否启用代理 | `false` |

### 3. 代理配置（可选）

**支持的代理类型**:
- DataImpulse 动态代理（推荐）
- 其他 HTTP/HTTPS 代理

**DataImpulse 配置示例**:
```json
{
  "proxy": {
    "enabled": true,
    "host": "74.81.81.81",
    "start_port": 10000,
    "username": "your_username",
    "password": "your_password",
    "countries": "sg,gb,hk,jp"
  }
}
```

---

## 📖 使用说明

### 启动菜单选项

运行 `python launcher.py` 后，您将看到以下选项：

```
1. [主程序] AIX 监控 (aix_monitor.py) ★网页开盘价+API当前价
2. [管理] 订单管理 (order_manager.py)
3. [任务] 每日任务检查 (check_tasks.py)
4. [战队] 批量加入战队 (join_teams.py)
5. [登录] 批量登录 (batch_login.py)
0. 退出
```

### 各模块功能详解

#### 1. AIX 监控 (主程序)
**功能**: 实时监控网页倒计时，自动触发批量下注

**运行流程**:
```
启动浏览器 → 打开页面 → CloudFlare 验证 → 初始化 API 客户端
    ↓
监控倒计时 → 检测触发条件 → 获取 C10 数据 → 批量下单
    ↓
动态替补 → 继续监控 → 循环执行
```

**日志示例**:
```
[18:30:45] 倒计时: 00:05 | 颜色: emerald
[18:30:48] 倒计时: 00:03 | 颜色: emerald
🎯 [18:30:48.123] 触发条件满足! (倒计时=3s)
==================================================
🔔 Round #12345 趋势: UP
   C10 开盘: 1234.5678
   C10 当前: 1235.1234
   涨跌幅:   +0.5556 (+0.0450%)
  [▶] 正在批量下单...
  [✓] 下单完成: 4/4 成功
==================================================
```

#### 2. 订单管理
**功能**: 查看账户状态、手动触发下单

**适用场景**:
- 测试账户登录状态
- 手动执行单次下注
- 查看账户积分进度

#### 3. 每日任务检查
**功能**: 批量检查并领取所有账号的每日任务

**使用方法**:
```bash
python check_tasks.py
```

**输出示例**:
```
[1/10] 正在检查 0x1234567890...
  ✅ 每日任务已领取
[2/10] 正在检查 0xabcdef1234...
  ⏳ 每日任务未完成
```

#### 4. 批量加入战队
**功能**: 让所有账号加入指定邀请码的战队

**使用方法**:
```bash
python join_teams.py
# 按提示输入战队邀请码
```

#### 5. 批量登录
**功能**: 预先登录所有账号并缓存会话

**使用方法**:
```bash
python batch_login.py
```

**优势**:
- 减少主程序启动时间
- 提前验证账号有效性
- 缓存会话供后续使用

---

## 🔧 性能优化

### 已实施的优化

1. **HTTP 连接池优化**
   - 总连接数: 100
   - 每 Host 连接数: 20
   - DNS 缓存: 5 分钟
   - Keep-Alive: 60 秒

2. **会话预热机制**
   - 启动时预热前 N 个账号
   - 减少首次下单延迟 50%+

3. **并行数据获取**
   - 使用 `asyncio.gather` 并行获取多个数据源
   - 节省约 50% 数据获取时间

4. **动态替补模式**
   - 保持满额并发
   - 避免账号闲置
   - 最大化吞吐量

### 性能指标

| 指标 | 数值 |
|------|------|
| 单次下单延迟 | < 200ms |
| API 响应时间 | < 1000ms |
| CloudFlare 通过率 | > 95% |
| 并发账号数 | 4（可配置） |

---

## ❓ 常见问题

### Q1: CloudFlare 验证失败怎么办？

**A**: 系统已集成 Playwright Stealth 插件，通常会自动通过验证。如果仍然失败：
1. 检查代理配置是否正确
2. 尝试关闭无头模式（`headless: false`）观察验证过程
3. 增加验证等待时间（代码中 `max_wait_time` 参数）

### Q2: 为什么积分显示不准确？

**A**: 由于官方 API 限制，实时积分仅在登录时更新。运行期间显示的是"本地计算"的进度，这是正常现象。

### Q3: 如何调整触发时机？

**A**: 修改 `config.json` 中的 `trigger.countdown_seconds` 参数：
- 默认值: `3`（倒计时剩余 3 秒触发）
- 建议范围: `1-5` 秒
- 过小可能导致数据获取不及时，过大可能影响胜率

### Q4: 代理是否必须？

**A**: 不是必须的，但强烈推荐：
- **不使用代理**: 可能导致 IP 被封（尤其是多账号）
- **使用代理**: 更稳定，降低封号风险

### Q5: 如何查看详细日志？

**A**: 在 `enhanced_browser_api_client.py` 初始化时设置 `verbose=True`：
```python
self.api_client = EnhancedBrowserAPIClient(
    page=self.page,
    verbose=True  # 开启详细日志
)
```

---

## ⚠️ 免责声明

**本工具仅供学习与研究使用。**

- ✅ 允许: 个人学习、技术研究、代码参考
- ❌ 禁止: 商业用途、恶意攻击、违反平台规则

**风险提示**:
1. 使用自动化工具可能违反平台服务条款
2. 可能导致账号封禁、资金损失等后果
3. 私钥安全由使用者自行负责
4. 作者不对任何损失承担责任

**使用本工具即表示您已充分理解并接受上述风险。请遵守平台规则，理性使用。**

---

## 📝 更新日志

### v2.0.0 (2026-01-27)
- ✨ 集成增强版浏览器 API 客户端
- ✨ 实现动态替补并发模式
- ✨ 添加 Playwright Stealth 插件
- 🔧 优化 HTTP 连接池配置
- 🔧 实现会话预热机制
- 📝 全面重写 README 文档

### v1.0.0 (2026-01-26)
- 🎉 初始版本发布
- ✨ 基础监控与下单功能
- ✨ 多账号管理
- ✨ 每日任务自动领取

---

## 📞 联系与支持

如有问题或建议，欢迎提交 Issue 或 Pull Request。

**祝您使用愉快！** 🚀
